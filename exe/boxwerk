#!/usr/bin/env ruby
# frozen_string_literal: true

# Boxwerk is designed to be installed globally (gem install boxwerk) rather
# than via Bundler. This ensures gems are loaded exactly once — in the root
# box — and inherited by all child boxes via Ruby::Box's copy-on-write.

unless defined?(Ruby::Box)
  $stderr.puts "Error: Ruby::Box is not available."
  $stderr.puts "Boxwerk requires Ruby 4.0 or later with Ruby::Box support."
  exit 1
end

unless Ruby::Box.enabled?
  $stderr.puts "Error: Ruby::Box is not enabled."
  $stderr.puts "Set the RUBY_BOX=1 environment variable before starting Ruby."
  exit 1
end

# Resolve boxwerk's lib directory from the installed gem location.
boxwerk_lib = File.expand_path('../lib', __dir__)

# Load and run in the root box. Boxwerk is loaded first (before Bundler
# restricts $LOAD_PATH), then project gems are loaded via Bundler. All
# definitions end up in the root box, inherited by child boxes.
Ruby::Box.root.eval(<<~RUBY)
  $LOAD_PATH.unshift(#{boxwerk_lib.inspect})
  require 'boxwerk'

  # Load project gems via Bundler if a Gemfile or gems.rb exists.
  gemfile = %w[gems.rb Gemfile].find { |f| File.exist?(f) }
  if gemfile
    ENV['BUNDLE_GEMFILE'] ||= File.expand_path(gemfile)
    require 'bundler/setup'
    Bundler.require
  end

  Boxwerk::CLI.run(ARGV)
RUBY
